-- Performance Optimization: Database Indexes
-- Expected Impact: 60-80% reduction in query time

-- Brand profiles indexes
CREATE INDEX IF NOT EXISTS idx_brand_profiles_user_id 
ON brand_profiles(user_id);

CREATE INDEX IF NOT EXISTS idx_brand_profiles_persona_category 
ON brand_profiles(persona, category) WHERE persona IS NOT NULL AND category IS NOT NULL;

-- Social accounts indexes
CREATE INDEX IF NOT EXISTS idx_social_accounts_user_platform 
ON social_accounts(user_id, platform) WHERE is_disconnected = false;

CREATE INDEX IF NOT EXISTS idx_social_accounts_platform_active 
ON social_accounts(platform, is_disconnected, connected_at) 
WHERE is_disconnected = false;

-- User subscription status indexes
CREATE INDEX IF NOT EXISTS idx_user_subscription_status_user_id 
ON user_subscription_status(user_id);

CREATE INDEX IF NOT EXISTS idx_user_subscription_status_trial 
ON user_subscription_status(is_trial_active, trial_ends_at) 
WHERE is_trial_active = true;

-- Brand kits indexes (only if table exists)
DO $$
BEGIN
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'brand_kits') THEN
        CREATE INDEX IF NOT EXISTS idx_brand_kits_user_id ON brand_kits(user_id);
    END IF;
END $$;

-- History/posts indexes (only if table exists)
DO $$
BEGIN
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'posts') THEN
        CREATE INDEX IF NOT EXISTS idx_posts_user_id_created ON posts(user_id, created_at DESC) WHERE user_id IS NOT NULL;
    END IF;
END $$;

-- Analyze tables after index creation (only if they exist)
DO $$
BEGIN
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'brand_profiles') THEN
        ANALYZE brand_profiles;
    END IF;
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'social_accounts') THEN
        ANALYZE social_accounts;
    END IF;
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'user_subscription_status') THEN
        ANALYZE user_subscription_status;
    END IF;
    IF EXISTS (SELECT FROM information_schema.tables WHERE table_name = 'brand_kits') THEN
        ANALYZE brand_kits;
    END IF;
END $$;

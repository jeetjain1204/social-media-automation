-- Create history table if it doesn't exist
CREATE TABLE IF NOT EXISTS history (
  id BIGSERIAL PRIMARY KEY,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  post_id UUID REFERENCES scheduled_posts(id),
  platform TEXT NOT NULL,
  content_text TEXT,
  media_url TEXT,
  posted_at TIMESTAMPTZ NOT NULL,
  views INT DEFAULT 0,
  likes INT DEFAULT 0,
  shares INT DEFAULT 0,
  status TEXT DEFAULT 'success',
  external_id TEXT,
  external_url TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Add any missing columns to the history table
ALTER TABLE history ADD COLUMN IF NOT EXISTS external_id TEXT;
ALTER TABLE history ADD COLUMN IF NOT EXISTS external_url TEXT;

-- Add RLS policies
ALTER TABLE history ENABLE ROW LEVEL SECURITY;

-- Allow users to view their own history
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'history' AND policyname = 'Users can view their own history') THEN
        CREATE POLICY "Users can view their own history" 
          ON history FOR SELECT 
          USING (auth.uid() = user_id);
    END IF;
END $$;

-- Allow backend service to insert into history
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'history' AND policyname = 'Service can insert history') THEN
        CREATE POLICY "Service can insert history" 
          ON history FOR INSERT 
          WITH CHECK (true);
    END IF;
END $$;

-- Allow users to update their own history
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE tablename = 'history' AND policyname = 'Users can update their own history') THEN
        CREATE POLICY "Users can update their own history" 
          ON history FOR UPDATE 
          USING (auth.uid() = user_id);
    END IF;
END $$; 